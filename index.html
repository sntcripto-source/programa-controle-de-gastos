<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Gastos Pessoais</title>
    <style>
/* Design System Variables */
:root {
    --primary-bg: #0f0f23;
    --secondary-bg: #1a1a2e;
    --card-bg: rgba(30, 30, 50, 0.6);
    --surface-2: rgba(148, 163, 184, 0.1);
    --accent-1: #6366f1;
    --accent-2: #8b5cf6;
    --accent-3: #ec4899;
    --text-primary: #f8fafc;
    --text-secondary: #94a3b8;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --border: rgba(148, 163, 184, 0.1);
    --shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
    --glow: 0 0 20px rgba(99, 102, 241, 0.3);
}

/* Global Styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 100%);
    color: var(--text-primary);
    min-height: 100vh;
    padding: 20px;
    line-height: 1.6;
}

/* Container */
.container {
    max-width: 1400px;
    margin: 0 auto;
}

/* Header */
.header {
    background: var(--card-bg);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px 32px;
    margin-bottom: 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow);
}

.header h1 {
    font-size: 2rem;
    background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.header-actions {
    display: flex;
    gap: 12px;
}

/* Dashboard */
.dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 24px;
}

.stat-card {
    background: var(--card-bg);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    display: flex;
    align-items: center;
    gap: 16px;
    transition: all 0.3s ease;
    box-shadow: var(--shadow);
}

.stat-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--glow), var(--shadow);
    border-color: var(--accent-1);
}

.stat-icon {
    font-size: 2.5rem;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
    border-radius: 12px;
}

.stat-content h3 {
    font-size: 0.875rem;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    background: linear-gradient(135deg, var(--accent-2), var(--accent-3));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

/* Month Selector Card */
.month-selector-card .stat-content {
    width: 100%;
}

.month-selector-card select {
    width: 100%;
    padding: 10px 14px;
    background: rgba(15, 15, 35, 0.7);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 0.875rem;
    margin-bottom: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.month-selector-card select:focus {
    outline: none;
    border-color: var(--accent-1);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.month-selector-card select:hover {
    border-color: var(--accent-1);
}


/* Tabs */
.tabs {
    display: flex;
    gap: 12px;
    margin-bottom: 24px;
    overflow-x: auto;
    padding: 4px;
}

.tab-btn {
    background: var(--card-bg);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px 24px;
    color: var(--text-secondary);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
}

.tab-btn:hover {
    background: rgba(99, 102, 241, 0.1);
    border-color: var(--accent-1);
    color: var(--text-primary);
}

.tab-btn.active {
    background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
    border-color: transparent;
    color: white;
    box-shadow: var(--glow);
}

.tab-icon {
    font-size: 1.25rem;
}

/* Tab Content */
.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Content Grid */
.content-grid {
    display: grid;
    grid-template-columns: 400px 1fr;
    gap: 24px;
}

@media (max-width: 1024px) {
    .content-grid {
        grid-template-columns: 1fr;
    }
}

/* Cards */
.form-card,
.list-card {
    background: var(--card-bg);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px;
    box-shadow: var(--shadow);
}

.form-card h2,
.list-card h2 {
    font-size: 1.5rem;
    margin-bottom: 24px;
    background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

/* Forms */
.form-group {
    margin-bottom: 20px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

.form-group label {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 12px 16px;
    background: rgba(15, 15, 35, 0.5);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 1rem;
    transition: all 0.3s ease;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--accent-1);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

/* Buttons */
.btn-primary,
.btn-secondary,
.btn-danger {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-primary {
    width: 100%;
    background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
    color: white;
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
}

.btn-secondary {
    background: var(--card-bg);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border);
    color: var(--text-primary);
}

.btn-secondary:hover {
    border-color: var(--accent-1);
    background: rgba(99, 102, 241, 0.1);
}

.btn-danger {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid var(--danger);
    color: var(--danger);
    padding: 8px 16px;
    font-size: 0.875rem;
}

.btn-danger:hover {
    background: var(--danger);
    color: white;
}

/* Items List */
.items-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-height: 600px;
    overflow-y: auto;
    padding-right: 8px;
}

.item {
    background: rgba(15, 15, 35, 0.5);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    transition: all 0.3s ease;
}

.item:hover {
    border-color: var(--accent-1);
    transform: translateX(4px);
}

.item-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 12px;
}

.item-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
}

.item-amount {
    font-size: 1.25rem;
    font-weight: 700;
}

.item-amount.positive {
    color: var(--success);
}

.item-amount.negative {
    color: var(--danger);
}

.item-details {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 12px;
}

.item-tag {
    display: inline-block;
    padding: 4px 12px;
    background: rgba(99, 102, 241, 0.1);
    border: 1px solid var(--accent-1);
    border-radius: 6px;
    font-size: 0.75rem;
    color: var(--accent-1);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.item-tag.status-paid {
    background: rgba(16, 185, 129, 0.1);
    border-color: var(--success);
    color: var(--success);
}

.item-tag.status-overdue {
    background: rgba(239, 68, 68, 0.1);
    border-color: var(--danger);
    color: var(--danger);
}

.item-tag.status-pending {
    background: rgba(245, 158, 11, 0.1);
    border-color: var(--warning);
    color: var(--warning);
}

.item-tag.installment-badge {
    background: rgba(139, 92, 246, 0.15);
    border-color: var(--accent-2);
    color: var(--accent-2);
    font-weight: 600;
}

.item-tag.month-badge {
    background: rgba(236, 72, 153, 0.15);
    border-color: var(--accent-3);
    color: var(--accent-3);
    font-weight: 600;
}

/* Monthly Summary */
.monthly-summary {
    background: rgba(99, 102, 241, 0.05);
    border: 1px solid rgba(99, 102, 241, 0.2);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
}

.monthly-summary h3 {
    font-size: 1rem;
    margin-bottom: 16px;
    color: var(--accent-1);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.monthly-summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
}

.month-item {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s ease;
}

.month-item:hover {
    transform: translateX(4px);
    border-color: var(--accent-1);
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15));
}

.month-name {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.month-value {
    font-size: 1rem;
    font-weight: 700;
    color: var(--accent-2);
}

.items-list-wrapper {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.item-actions {
    display: flex;
    justify-content: flex-end;
}

/* Filter Bar */
.filter-bar {
    margin-bottom: 16px;
}

.filter-bar select {
    width: 100%;
    padding: 10px 14px;
    background: rgba(15, 15, 35, 0.5);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 0.875rem;
}

/* Month Buttons */
.month-buttons-container {
    background: rgba(99, 102, 241, 0.03);
    border: 1px solid rgba(99, 102, 241, 0.1);
    border-radius: 12px;
    padding: 16px;
}

.month-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.month-btn {
    font-family: inherit;
    font-weight: 600;
    letter-spacing: 0.3px;
}

.month-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

.month-btn:active {
    transform: translateY(0);
}

.month-btn.active {
    font-weight: 700;
    box-shadow: 0 4px 16px rgba(99, 102, 241, 0.4);
}

/* Custom Scrollbar */
.items-list::-webkit-scrollbar {
    width: 8px;
}

.items-list::-webkit-scrollbar-track {
    background: rgba(15, 15, 35, 0.3);
    border-radius: 4px;
}

.items-list::-webkit-scrollbar-thumb {
    background: var(--accent-1);
    border-radius: 4px;
}

.items-list::-webkit-scrollbar-thumb:hover {
    background: var(--accent-2);
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 48px 24px;
    color: var(--text-secondary);
}

.empty-state-icon {
    font-size: 4rem;
    margin-bottom: 16px;
    opacity: 0.5;
}

.empty-state-text {
    font-size: 1.125rem;
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    animation: fadeIn 0.3s ease;
}

.modal.active {
    display: flex;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background: var(--card-bg);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 0;
    width: 90%;
    max-width: 500px;
    box-shadow: var(--shadow);
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modal-header {
    padding: 24px 28px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    font-size: 1.5rem;
    background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin: 0;
}

.close-btn {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    font-size: 1.5rem;
    cursor: pointer;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.close-btn:hover {
    background: rgba(239, 68, 68, 0.1);
    color: var(--danger);
}

.modal-body {
    padding: 28px;
}

.modal-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
}

.modal-actions .btn-primary,
.modal-actions .btn-secondary {
    flex: 1;
}


/* Responsive */
@media (max-width: 768px) {
    .header {
        flex-direction: column;
        gap: 16px;
        text-align: center;
    }

    .header h1 {
        font-size: 1.5rem;
    }

    .dashboard {
        grid-template-columns: 1fr;
    }

    .tabs {
        flex-wrap: nowrap;
    }

    .tab-btn {
        font-size: 0.875rem;
        padding: 10px 16px;
    }

    .form-row {
        grid-template-columns: 1fr;
    }

    .stat-value {
        font-size: 1.25rem;
    }
}
</style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>üí∞ Controle de Gastos</h1>
            <div class="header-actions">
                <button class="btn-secondary" onclick="app.openMonthFilterModal()">üìÖ M√™s</button>
                <button class="btn-secondary" onclick="app.exportData()">üì• Exportar</button>
                <button class="btn-secondary" onclick="app.importData()">üì§ Importar</button>
            </div>
        </header>

        <!-- Month Filter Modal -->
        <div id="month-filter-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üìÖ Filtrar por M√™s e Ano</h2>
                    <button class="close-btn" onclick="app.closeMonthFilterModal()">‚úï</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>M√™s</label>
                        <select id="filter-month">
                            <option value="">Todos os Meses</option>
                            <option value="01">Janeiro</option>
                            <option value="02">Fevereiro</option>
                            <option value="03">Mar√ßo</option>
                            <option value="04">Abril</option>
                            <option value="05">Maio</option>
                            <option value="06">Junho</option>
                            <option value="07">Julho</option>
                            <option value="08">Agosto</option>
                            <option value="09">Setembro</option>
                            <option value="10">Outubro</option>
                            <option value="11">Novembro</option>
                            <option value="12">Dezembro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ano</label>
                        <select id="filter-year">
                            <option value="">Todos os Anos</option>
                        </select>
                    </div>
                    <div class="modal-actions">
                        <button class="btn-primary" onclick="app.applyMonthYearFilter()">Aplicar Filtro</button>
                        <button class="btn-secondary" onclick="app.clearMonthYearFilter()">Limpar Filtro</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Summary -->
        <section class="dashboard">
            <div class="stat-card">
                <div class="stat-icon">üí∏</div>
                <div class="stat-content">
                    <h3>Gastos Totais</h3>
                    <p class="stat-value" id="total-expenses">R$ 0,00</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìÖ</div>
                <div class="stat-content">
                    <h3>Gastos Fixos/M√™s</h3>
                    <p class="stat-value" id="fixed-monthly">R$ 0,00</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üöó</div>
                <div class="stat-content">
                    <h3>Gastos com Carro/M√™s</h3>
                    <p class="stat-value" id="car-total">R$ 0,00</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-content">
                    <h3>Empr√©stimos</h3>
                    <p class="stat-value" id="loans-balance">R$ 0,00</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üõí</div>
                <div class="stat-content">
                    <h3>Gastos Gerais</h3>
                    <p class="stat-value" id="general-total">R$ 0,00</p>
                </div>
            </div>

        </section>

        <!-- Tab Navigation -->
        <nav class="tabs">
            <button class="tab-btn active" onclick="app.switchTab('loans')">
                <span class="tab-icon">üí≥</span>
                Empr√©stimos
            </button>
            <button class="tab-btn" onclick="app.switchTab('fixed')">
                <span class="tab-icon">üìã</span>
                Gastos Fixos
            </button>
            <button class="tab-btn" onclick="app.switchTab('car')">
                <span class="tab-icon">üöó</span>
                Carro
            </button>
            <button class="tab-btn" onclick="app.switchTab('general')">
                <span class="tab-icon">üõí</span>
                Gastos Gerais
            </button>
        </nav>

        <!-- Empr√©stimos Tab -->
        <section id="loans-tab" class="tab-content active">
            <div class="content-grid">
                <div class="form-card">
                    <h2>Adicionar Empr√©stimo</h2>
                    <form id="loan-form" onsubmit="app.addLoan(event)">
                        <div class="form-group">
                            <label>Descri√ß√£o</label>
                            <input type="text" name="description" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Valor da Parcela (R$)</label>
                                <input type="number" name="amount" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>Tipo</label>
                                <select name="type" required>
                                    <option value="borrowed">Emprestado (Devo)</option>
                                    <option value="lent">Emprestei</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Taxa de Juros (%)</label>
                                <input type="number" name="interest" step="0.01" value="0">
                            </div>
                            <div class="form-group">
                                <label>Vencimento</label>
                                <input type="date" name="dueDate">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select name="status" required>
                                <option value="pending">Pendente</option>
                                <option value="paid">Pago</option>
                                <option value="overdue">Atrasado</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="isInstallment" id="loan-installment-check"
                                    onchange="app.toggleInstallmentFields('loan')">
                                Parcelar?
                            </label>
                        </div>
                        <div id="loan-installment-fields" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>N√∫mero de Parcelas</label>
                                    <input type="number" name="installments" min="2" max="120" value="12">
                                </div>
                                <div class="form-group">
                                    <label>Data de In√≠cio</label>
                                    <input type="date" name="installmentStartDate">
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn-primary">Adicionar</button>
                    </form>
                </div>
                <div class="list-card">
                    <h2>Empr√©stimos</h2>
                    <div class="filter-bar">
                        <select id="loans-month-filter" onchange="app.filterLoans()">
                            <option value="">Todos os Meses</option>
                        </select>
                        <button class="btn-danger" onclick="app.deleteMonthData('loans')" style="margin-left: 8px;">üóëÔ∏è
                            Excluir M√™s</button>
                    </div>
                    <div id="loans-list" class="items-list"></div>
                </div>
            </div>
        </section>

        <!-- Gastos Fixos Tab -->
        <section id="fixed-tab" class="tab-content">
            <div class="content-grid">
                <div class="form-card">
                    <h2>Adicionar Gasto Fixo</h2>
                    <form id="fixed-form" onsubmit="app.addFixed(event)">
                        <div class="form-group">
                            <label>Descri√ß√£o</label>
                            <input type="text" name="description" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Valor Mensal (R$)</label>
                                <input type="number" name="amount" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>Categoria</label>
                                <select name="category" required>
                                    <option value="rent">Aluguel</option>
                                    <option value="internet">Internet</option>
                                    <option value="phone">Telefone</option>
                                    <option value="utilities">Contas (√Ågua/Luz/G√°s)</option>
                                    <option value="subscription">Assinaturas</option>
                                    <option value="other">Outros</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Dia do Vencimento</label>
                            <input type="number" name="dueDay" min="1" max="31" required>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="isInstallment" id="fixed-installment-check"
                                    onchange="app.toggleInstallmentFields('fixed')">
                                Parcelar?
                            </label>
                        </div>
                        <div id="fixed-installment-fields" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>N√∫mero de Parcelas</label>
                                    <input type="number" name="installments" min="2" max="120" value="12">
                                </div>
                                <div class="form-group">
                                    <label>Data de In√≠cio</label>
                                    <input type="date" name="installmentStartDate">
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn-primary">Adicionar</button>
                    </form>
                </div>
                <div class="list-card">
                    <h2>Gastos Fixos Mensais</h2>
                    <div class="filter-bar">
                        <select id="fixed-month-filter" onchange="app.filterFixed()">
                            <option value="">Todos os Meses</option>
                        </select>
                    </div>
                    <div id="fixed-list" class="items-list"></div>
                </div>
            </div>
        </section>

        <!-- Carro Tab -->
        <section id="car-tab" class="tab-content">
            <div class="content-grid">
                <div class="form-card">
                    <h2>Adicionar Gasto com Carro</h2>
                    <form id="car-form" onsubmit="app.addCar(event)">
                        <div class="form-group">
                            <label>Descri√ß√£o</label>
                            <input type="text" name="description" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Valor (R$)</label>
                                <input type="number" name="amount" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>Categoria</label>
                                <select name="category" required>
                                    <option value="fuel">Combust√≠vel</option>
                                    <option value="maintenance">Manuten√ß√£o</option>
                                    <option value="insurance">Seguro</option>
                                    <option value="taxes">Impostos</option>
                                    <option value="repairs">Reparos</option>
                                    <option value="other">Outros</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Data</label>
                                <input type="date" name="date" required>
                            </div>
                            <div class="form-group">
                                <label>Quilometragem (opcional)</label>
                                <input type="number" name="mileage">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="isInstallment" id="car-installment-check"
                                    onchange="app.toggleInstallmentFields('car')">
                                Parcelar?
                            </label>
                        </div>
                        <div id="car-installment-fields" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>N√∫mero de Parcelas</label>
                                    <input type="number" name="installments" min="2" max="120" value="12">
                                </div>
                                <div class="form-group">
                                    <label>M√™s de In√≠cio (opcional)</label>
                                    <input type="month" name="installmentStartMonth">
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn-primary">Adicionar</button>
                    </form>
                </div>
                <div class="list-card">
                    <h2>Hist√≥rico de Gastos</h2>
                    <div class="filter-bar">
                        <select id="car-month-filter" onchange="app.filterCar()">
                            <option value="">Todos os Meses</option>
                        </select>
                        <button class="btn-danger" onclick="app.deleteMonthData('car')" style="margin-left: 8px;">üóëÔ∏è
                            Excluir M√™s</button>
                    </div>
                    <div id="car-list" class="items-list"></div>
                </div>
            </div>
        </section>

        <!-- Gastos Gerais Tab -->
        <section id="general-tab" class="tab-content">
            <div class="content-grid">
                <div class="form-card">
                    <h2>Adicionar Gasto Geral</h2>
                    <form id="general-form" onsubmit="app.addGeneral(event)">
                        <div class="form-group">
                            <label>Descri√ß√£o</label>
                            <input type="text" name="description" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Valor (R$)</label>
                                <input type="number" name="amount" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>Categoria</label>
                                <select name="category" required>
                                    <option value="food">Alimenta√ß√£o</option>
                                    <option value="transport">Transporte</option>
                                    <option value="health">Sa√∫de</option>
                                    <option value="entertainment">Lazer</option>
                                    <option value="education">Educa√ß√£o</option>
                                    <option value="clothing">Vestu√°rio</option>
                                    <option value="shopping">Compras</option>
                                    <option value="other">Outros</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Data</label>
                            <input type="date" name="date" required>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="isInstallment" id="general-installment-check"
                                    onchange="app.toggleInstallmentFields('general')">
                                Parcelar?
                            </label>
                        </div>
                        <div id="general-installment-fields" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>N√∫mero de Parcelas</label>
                                    <input type="number" name="installments" min="2" max="120" value="12">
                                </div>
                                <div class="form-group">
                                    <label>M√™s de In√≠cio (opcional)</label>
                                    <input type="month" name="installmentStartMonth">
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn-primary">Adicionar</button>
                    </form>
                </div>
                <div class="list-card">
                    <h2>Hist√≥rico de Gastos</h2>
                    <div class="filter-bar">
                        <select id="general-month-filter" onchange="app.filterGeneral()">
                            <option value="">Todos os Meses</option>
                        </select>
                        <button class="btn-danger" onclick="app.deleteMonthData('general')"
                            style="margin-left: 8px;">üóëÔ∏è Excluir M√™s</button>
                    </div>
                    <div id="general-list" class="items-list"></div>
                </div>
            </div>
        </section>
    </div>

    <input type="file" id="import-file" accept=".json" style="display: none;" onchange="app.handleImport(event)">

    <script>
// Expense Tracker Application
const app = {
    // Data storage
    data: {
        loans: [],
        fixed: [],
        car: [],
        general: []
    },

    // Initialize app
    init() {
        this.loadData();
        this.renderAll();
        this.updateDashboard();
        this.populateAllMonthFilters();
        this.populateDashboardMonthSelector();

        // Set default date inputs to today
        const today = new Date().toISOString().split('T')[0];
        document.querySelectorAll('input[type="date"]').forEach(input => {
            if (!input.value) input.value = today;
        });
    },

    // Load data from localStorage
    loadData() {
        const saved = localStorage.getItem('expenseTrackerData');
        if (saved) {
            this.data = JSON.parse(saved);
        }
    },

    // Save data to localStorage
    saveData() {
        localStorage.setItem('expenseTrackerData', JSON.stringify(this.data));
    },

    // Switch tabs
    switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.closest('.tab-btn').classList.add('active');

        // Update tab content
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById(`${tabName}-tab`).classList.add('active');
    },

    // Toggle installment fields visibility
    toggleInstallmentFields(category) {
        const fieldsDiv = document.getElementById(`${category}-installment-fields`);
        const checkbox = document.getElementById(`${category}-installment-check`);
        fieldsDiv.style.display = checkbox.checked ? 'block' : 'none';
    },

    // Helper: Add months to a date
    addMonthsToDate(dateStr, months) {
        const date = new Date(dateStr + 'T00:00:00');
        const targetMonth = (date.getMonth() + months) % 12;
        const targetYear = date.getFullYear() + Math.floor((date.getMonth() + months) / 12);

        // Get the day of the original date
        const day = date.getDate();

        // Set to the first day of the target month/year
        date.setFullYear(targetYear, targetMonth, 1);

        // Get the last day of this month
        const lastDayOfMonth = new Date(targetYear, targetMonth + 1, 0).getDate();

        // Set to the minimum of the original day or the last day of the target month
        date.setDate(Math.min(day, lastDayOfMonth));

        return date.toISOString().split('T')[0];
    },

    // Helper: Create installments
    createInstallments(baseItem, totalInstallments, startDate, category) {
        const installments = [];
        // For loans, amount is already the installment value (manual input)
        // For other categories, we divide the total by installments
        const installmentAmount = category === 'loans' ? baseItem.amount : baseItem.amount / totalInstallments;
        const totalAmount = category === 'loans' ? baseItem.amount * totalInstallments : baseItem.amount;

        for (let i = 0; i < totalInstallments; i++) {
            const installmentDate = this.addMonthsToDate(startDate, i);
            const installment = {
                ...baseItem,
                id: Date.now() + i,
                amount: installmentAmount,
                isInstallment: true,
                installmentNumber: i + 1,
                totalInstallments: totalInstallments,
                installmentDate: installmentDate,
                parentId: baseItem.id,
                originalAmount: totalAmount
            };

            // Update date field based on category
            if (category === 'loans') {
                installment.dueDate = installmentDate;
            } else if (category === 'car' || category === 'general') {
                installment.date = installmentDate;
            }

            installments.push(installment);
        }

        return installments;
    },

    // Helper: Get monthly totals
    getMonthlyTotals(items, category) {
        const monthlyTotals = {};

        items.forEach(item => {
            let monthKey;

            // Get the appropriate date field based on category
            if (item.installmentDate) {
                monthKey = item.installmentDate.substring(0, 7);
            } else if (item.dueDate && category === 'loans') {
                monthKey = item.dueDate.substring(0, 7);
            } else if (item.date) {
                monthKey = item.date.substring(0, 7);
            } else {
                return; // Skip items without dates
            }

            if (!monthlyTotals[monthKey]) {
                monthlyTotals[monthKey] = 0;
            }

            monthlyTotals[monthKey] += item.amount;
        });

        // Convert to sorted array
        return Object.keys(monthlyTotals)
            .sort()
            .map(month => ({
                month,
                total: monthlyTotals[month]
            }));
    },

    // Helper: Render monthly summary
    renderMonthlySummary(monthlyData) {
        if (monthlyData.length === 0) return '';

        return `
            <div class="monthly-summary">
                <h3>üìÖ Resumo Mensal</h3>
                <div class="monthly-summary-grid">
                    ${monthlyData.map(item => `
                        <div class="month-item">
                            <span class="month-name">${this.formatMonthYear(item.month)}</span>
                            <span class="month-value">R$ ${item.total.toFixed(2)}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    },

    // Loans functions
    addLoan(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);

        const loan = {
            id: Date.now(),
            description: formData.get('description'),
            amount: parseFloat(formData.get('amount')),
            type: formData.get('type'),
            interest: parseFloat(formData.get('interest')),
            dueDate: formData.get('dueDate'),
            status: formData.get('status'),
            createdAt: new Date().toISOString()
        };

        // Check if installment is enabled
        const isInstallment = formData.get('isInstallment') === 'on';

        if (isInstallment) {
            const installments = parseInt(formData.get('installments')) || 12;
            const startDate = formData.get('installmentStartDate') || new Date().toISOString().split('T')[0];

            const installmentItems = this.createInstallments(loan, installments, startDate, 'loans');
            this.data.loans.push(...installmentItems);
        } else {
            this.data.loans.push(loan);
        }

        this.saveData();
        this.renderLoans();
        this.updateDashboard();
        this.populateAllMonthFilters();
        this.populateDashboardMonthSelector();
        form.reset();
        // Reset installment fields visibility
        document.getElementById('loan-installment-fields').style.display = 'none';
    },

    renderLoans(filterMonth = '') {
        const container = document.getElementById('loans-list');

        let filtered = this.data.loans;

        if (filterMonth) {
            filtered = this.data.loans.filter(item => {
                const itemMonth = item.dueDate ? item.dueDate.substring(0, 7) : (item.installmentDate || '').substring(0, 7);
                return itemMonth === filterMonth;
            });
        }

        if (filtered.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üí≥</div>
                    <p class="empty-state-text">Nenhum empr√©stimo cadastrado</p>
                </div>
            `;
            return;
        }

        // Get monthly totals
        const monthlyData = this.getMonthlyTotals(filtered, 'loans');

        container.innerHTML = `
            ${this.createMonthButtons('loans', 'dueDate')}
            ${this.renderMonthlySummary(monthlyData)}
            <div class="items-list-wrapper">
                ${filtered.map(loan => {
            // Show the installment/parcel value
            const displayAmount = loan.amount;
            const isPositive = loan.type === 'lent';

            return `
                        <div class="item">
                            <div class="item-header">
                                <span class="item-title">${loan.description}</span>
                                <span class="item-amount ${isPositive ? 'positive' : 'negative'}">
                                    ${isPositive ? '+' : '-'} R$ ${displayAmount.toFixed(2)}
                                </span>
                            </div>
                            <div class="item-details">
                                <span class="item-tag">${loan.type === 'lent' ? 'Emprestei' : 'Devo'}</span>
                                <span class="item-tag status-${loan.status}">${this.getStatusLabel(loan.status)}</span>
                                ${loan.interest > 0 ? `<span class="item-tag">Juros: ${loan.interest}%</span>` : ''}
                                ${loan.dueDate ? `<span class="item-tag">Venc: ${this.formatDate(loan.dueDate)}</span>` : ''}
                                ${loan.isInstallment ? `<span class="item-tag installment-badge">Parcela ${loan.installmentNumber} de ${loan.totalInstallments}</span>` : ''}
                                ${loan.isInstallment ? `<span class="item-tag month-badge">${this.formatMonthYear(loan.installmentDate.substring(0, 7))}</span>` : ''}
                            </div>
                            <div class="item-actions">
                                <button class="btn-danger" onclick="app.deleteItem('loans', ${loan.id})">Excluir</button>
                                ${loan.isInstallment ? `<button class="btn-secondary" onclick="app.deleteInstallmentGroup('loans', ${loan.parentId})" style="margin-left: 8px; background-color: #6b7280;">Excluir Grupo</button>` : ''}
                            </div>
                        </div>
                    `;
        }).join('')}
            </div>
        `;
    },

    // Fixed expenses functions
    addFixed(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);

        const fixed = {
            id: Date.now(),
            description: formData.get('description'),
            amount: parseFloat(formData.get('amount')),
            category: formData.get('category'),
            dueDay: parseInt(formData.get('dueDay')),
            createdAt: new Date().toISOString()
        };

        // Check if installment is enabled
        const isInstallment = formData.get('isInstallment') === 'on';

        if (isInstallment) {
            const installments = parseInt(formData.get('installments')) || 12;
            const startDate = formData.get('installmentStartDate') || new Date().toISOString().split('T')[0];

            const installmentItems = this.createInstallments(fixed, installments, startDate, 'fixed');
            this.data.fixed.push(...installmentItems);
        } else {
            this.data.fixed.push(fixed);
        }

        this.saveData();
        this.renderFixed();
        this.updateDashboard();
        this.populateAllMonthFilters();
        this.populateDashboardMonthSelector();
        form.reset();
        document.getElementById('fixed-installment-fields').style.display = 'none';
    },

    renderFixed(filterMonth = '') {
        const container = document.getElementById('fixed-list');

        let filtered = this.data.fixed;

        if (filterMonth) {
            filtered = this.data.fixed.filter(item => {
                const itemMonth = item.installmentDate ? item.installmentDate.substring(0, 7) : '';
                return itemMonth === filterMonth;
            });
        }

        if (filtered.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üìã</div>
                    <p class="empty-state-text">Nenhum gasto fixo cadastrado</p>
                </div>
            `;
            return;
        }

        const total = filtered.reduce((sum, item) => sum + item.amount, 0);
        const monthlyData = this.getMonthlyTotals(filtered, 'fixed');

        container.innerHTML = `
            ${this.createMonthButtons('fixed', 'date')}
            ${this.renderMonthlySummary(monthlyData)}
            <div class="items-list-wrapper">
                ${filtered.map(item => `
                    <div class="item">
                        <div class="item-header">
                            <span class="item-title">${item.description}</span>
                            <span class="item-amount negative">R$ ${item.amount.toFixed(2)}</span>
                        </div>
                        <div class="item-details">
                            <span class="item-tag">${this.getCategoryLabel(item.category)}</span>
                            <span class="item-tag">Vencimento: dia ${item.dueDay}</span>
                            ${item.isInstallment ? `<span class="item-tag installment-badge">Parcela ${item.installmentNumber} de ${item.totalInstallments}</span>` : ''}
                            ${item.isInstallment ? `<span class="item-tag month-badge">${this.formatMonthYear(item.installmentDate.substring(0, 7))}</span>` : ''}
                        </div>
                        <div class="item-actions">
                            <button class="btn-danger" onclick="app.deleteItem('fixed', ${item.id})">Excluir</button>
                            ${item.isInstallment ? `<button class="btn-secondary" onclick="app.deleteInstallmentGroup('fixed', ${item.parentId})" style="margin-left: 8px; background-color: #6b7280;">Excluir Grupo</button>` : ''}
                        </div>
                    </div>
                `).join('')}
                <div class="item" style="background: rgba(99, 102, 241, 0.1); border-color: var(--accent-1);">
                    <div class="item-header">
                        <span class="item-title">Total Mensal</span>
                        <span class="item-amount negative" style="font-size: 1.5rem;">R$ ${total.toFixed(2)}</span>
                    </div>
                </div>
            </div>
        `;
    },

    // Car expenses functions
    addCar(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);

        const car = {
            id: Date.now(),
            description: formData.get('description'),
            amount: parseFloat(formData.get('amount')),
            category: formData.get('category'),
            date: formData.get('date'),
            mileage: formData.get('mileage') || null,
            createdAt: new Date().toISOString()
        };

        // Check if installment is enabled
        const isInstallment = formData.get('isInstallment') === 'on';

        if (isInstallment) {
            const installments = parseInt(formData.get('installments')) || 12;
            let startDate = formData.get('date');
            const startMonth = formData.get('installmentStartMonth');
            if (startMonth) {
                startDate = startMonth + '-01';
            }

            const installmentItems = this.createInstallments(car, installments, startDate, 'car');
            this.data.car.push(...installmentItems);
        } else {
            this.data.car.push(car);
        }

        this.saveData();
        this.renderCar();
        this.updateDashboard();
        this.populateAllMonthFilters();
        this.populateDashboardMonthSelector();
        form.reset();
        document.getElementById('car-installment-fields').style.display = 'none';
    },

    renderCar(filterMonth = '') {
        const container = document.getElementById('car-list');

        let filtered = this.data.car;

        if (filterMonth) {
            filtered = this.data.car.filter(item => {
                const itemMonth = item.date ? item.date.substring(0, 7) : (item.installmentDate || '').substring(0, 7);
                return itemMonth === filterMonth;
            });
        }

        if (filtered.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üöó</div>
                    <p class="empty-state-text">Nenhum gasto com carro cadastrado</p>
                </div>
            `;
            return;
        }

        // Sort by date descending
        const sorted = [...filtered].sort((a, b) => new Date(b.date) - new Date(a.date));
        const monthlyData = this.getMonthlyTotals(filtered, 'car');

        container.innerHTML = `
            ${this.createMonthButtons('car', 'date')}
            ${this.renderMonthlySummary(monthlyData)}
            <div class="items-list-wrapper">
                ${sorted.map(item => `
                    <div class="item">
                        <div class="item-header">
                            <span class="item-title">${item.description}</span>
                            <span class="item-amount negative">R$ ${item.amount.toFixed(2)}</span>
                        </div>
                        <div class="item-details">
                            <span class="item-tag">${this.getCategoryLabel(item.category)}</span>
                            <span class="item-tag">${this.formatDate(item.date)}</span>
                            ${item.mileage ? `<span class="item-tag">KM: ${item.mileage}</span>` : ''}
                            ${item.isInstallment ? `<span class="item-tag installment-badge">Parcela ${item.installmentNumber} de ${item.totalInstallments}</span>` : ''}
                            ${item.isInstallment ? `<span class="item-tag month-badge">${this.formatMonthYear(item.installmentDate.substring(0, 7))}</span>` : ''}
                        </div>
                        <div class="item-actions">
                            <button class="btn-danger" onclick="app.deleteItem('car', ${item.id})">Excluir</button>
                            ${item.isInstallment ? `<button class="btn-secondary" onclick="app.deleteInstallmentGroup('car', ${item.parentId})" style="margin-left: 8px; background-color: #6b7280;">Excluir Grupo</button>` : ''}
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    },

    // General expenses functions
    addGeneral(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);

        const general = {
            id: Date.now(),
            description: formData.get('description'),
            amount: parseFloat(formData.get('amount')),
            category: formData.get('category'),
            date: formData.get('date'),
            createdAt: new Date().toISOString()
        };

        // Check if installment is enabled
        const isInstallment = formData.get('isInstallment') === 'on';

        if (isInstallment) {
            const installments = parseInt(formData.get('installments')) || 12;
            let startDate = formData.get('date');
            const startMonth = formData.get('installmentStartMonth');
            if (startMonth) {
                startDate = startMonth + '-01';
            }

            const installmentItems = this.createInstallments(general, installments, startDate, 'general');
            this.data.general.push(...installmentItems);
        } else {
            this.data.general.push(general);
        }

        this.saveData();
        this.renderGeneral();
        this.updateDashboard();
        this.populateAllMonthFilters();
        this.populateDashboardMonthSelector();
        form.reset();
        document.getElementById('general-installment-fields').style.display = 'none';
    },

    renderGeneral(filterMonth = '') {
        const container = document.getElementById('general-list');

        let filtered = this.data.general;

        if (filterMonth) {
            filtered = this.data.general.filter(item => {
                const itemMonth = item.date.substring(0, 7);
                return itemMonth === filterMonth;
            });
        }

        if (filtered.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üõí</div>
                    <p class="empty-state-text">Nenhum gasto geral cadastrado</p>
                </div>
            `;
            return;
        }

        // Sort by date descending
        const sorted = [...filtered].sort((a, b) => new Date(b.date) - new Date(a.date));

        // Get monthly totals for filtered items
        const monthlyData = this.getMonthlyTotals(filtered, 'general');

        // Group by month
        const grouped = {};
        sorted.forEach(item => {
            const month = item.date.substring(0, 7);
            if (!grouped[month]) grouped[month] = [];
            grouped[month].push(item);
        });

        container.innerHTML = `
            ${this.createMonthButtons('general', 'date')}
            ${this.renderMonthlySummary(monthlyData)}
            <div class="items-list-wrapper">
                ${Object.keys(grouped).map(month => {
            const items = grouped[month];
            const monthTotal = items.reduce((sum, item) => sum + item.amount, 0);

            return `
                        <div style="margin-bottom: 24px;">
                            <h3 style="color: var(--text-secondary); margin-bottom: 12px; font-size: 0.875rem; text-transform: uppercase;">
                                ${this.formatMonthYear(month)} - Total: R$ ${monthTotal.toFixed(2)}
                            </h3>
                            ${items.map(item => `
                                <div class="item" style="margin-bottom: 8px;">
                                    <div class="item-header">
                                        <span class="item-title">${item.description}</span>
                                        <span class="item-amount negative">R$ ${item.amount.toFixed(2)}</span>
                                    </div>
                                    <div class="item-details">
                                        <span class="item-tag">${this.getCategoryLabel(item.category)}</span>
                                        <span class="item-tag">${this.formatDate(item.date)}</span>
                                        ${item.isInstallment ? `<span class="item-tag installment-badge">Parcela ${item.installmentNumber} de ${item.totalInstallments}</span>` : ''}
                                        ${item.isInstallment ? `<span class="item-tag month-badge">${this.formatMonthYear(item.installmentDate.substring(0, 7))}</span>` : ''}
                                    </div>
                                    <div class="item-actions">
                                        <button class="btn-danger" onclick="app.deleteItem('general', ${item.id})">Excluir</button>
                                        ${item.isInstallment ? `<button class="btn-secondary" onclick="app.deleteInstallmentGroup('general', ${item.parentId})" style="margin-left: 8px; background-color: #6b7280;">Excluir Grupo</button>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
        }).join('')}
            </div>
        `;
    },

    filterLoans() {
        const select = document.getElementById('loans-month-filter');
        this.renderLoans(select.value);
    },

    filterFixed() {
        const select = document.getElementById('fixed-month-filter');
        this.renderFixed(select.value);
    },

    filterCar() {
        const select = document.getElementById('car-month-filter');
        this.renderCar(select.value);
    },

    filterGeneral() {
        const select = document.getElementById('general-month-filter');
        this.renderGeneral(select.value);
    },

    populateMonthFilter(selectId, dataArray, dateField = 'date') {
        const select = document.getElementById(selectId);
        if (!select) return;

        const months = new Set();

        dataArray.forEach(item => {
            let monthKey = '';
            if (item.installmentDate) {
                monthKey = item.installmentDate.substring(0, 7);
            } else if (item[dateField]) {
                monthKey = item[dateField].substring(0, 7);
            }
            if (monthKey) months.add(monthKey);
        });

        const sortedMonths = Array.from(months).sort().reverse();

        select.innerHTML = '<option value="">Todos os Meses</option>' +
            sortedMonths.map(month =>
                `<option value="${month}">${this.formatMonthYear(month)}</option>`
            ).join('');
    },

    populateAllMonthFilters() {
        this.populateMonthFilter('loans-month-filter', this.data.loans, 'dueDate');
        this.populateMonthFilter('fixed-month-filter', this.data.fixed, 'date');
        this.populateMonthFilter('car-month-filter', this.data.car, 'date');
        this.populateMonthFilter('general-month-filter', this.data.general, 'date');
    },

    // Get available months for a category
    getAvailableMonths(dataArray, dateField = 'date') {
        const months = new Set();

        dataArray.forEach(item => {
            let monthKey = '';
            if (item.installmentDate) {
                monthKey = item.installmentDate.substring(0, 7);
            } else if (item[dateField]) {
                monthKey = item[dateField].substring(0, 7);
            }
            if (monthKey) months.add(monthKey);
        });

        return Array.from(months).sort().reverse();
    },

    // Create month buttons HTML
    createMonthButtons(category, dateField = 'date') {
        const dataArray = this.data[category];
        const months = this.getAvailableMonths(dataArray, dateField);

        if (months.length === 0) return '';

        const currentFilter = document.getElementById(`${category}-month-filter`)?.value || '';

        return `
            <div class="month-buttons-container" style="margin-bottom: 16px;">
                <div style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 8px; font-weight: 500;">
                    üìÖ Filtrar por m√™s:
                </div>
                <div class="month-buttons">
                    <button 
                        class="month-btn ${currentFilter === '' ? 'active' : ''}" 
                        onclick="app.selectMonth('${category}', '')"
                        style="padding: 8px 16px; background: ${currentFilter === '' ? 'var(--accent-1)' : 'var(--surface-2)'}; color: ${currentFilter === '' ? 'white' : 'var(--text-primary)'}; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 0.875rem; margin: 4px; transition: all 0.2s;">
                        Todos
                    </button>
                    ${months.slice(0, 6).map(month => `
                        <button 
                            class="month-btn ${currentFilter === month ? 'active' : ''}" 
                            onclick="app.selectMonth('${category}', '${month}')"
                            style="padding: 8px 16px; background: ${currentFilter === month ? 'var(--accent-1)' : 'var(--surface-2)'}; color: ${currentFilter === month ? 'white' : 'var(--text-primary)'}; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 0.875rem; margin: 4px; transition: all 0.2s; white-space: nowrap;">
                            ${this.formatMonthYear(month)}
                        </button>
                    `).join('')}
                </div>
            </div>
        `;
    },

    // Select month by clicking button
    selectMonth(category, month) {
        const select = document.getElementById(`${category}-month-filter`);
        if (select) {
            select.value = month;
        }

        // Call appropriate filter function
        switch (category) {
            case 'loans':
                this.renderLoans(month);
                break;
            case 'fixed':
                this.renderFixed(month);
                break;
            case 'car':
                this.renderCar(month);
                break;
            case 'general':
                this.renderGeneral(month);
                break;
        }
    },

    // Delete item
    deleteItem(category, id) {
        if (!confirm('Tem certeza que deseja excluir este item?')) return;

        this.data[category] = this.data[category].filter(item => item.id !== id);
        this.saveData();
        this.renderAll();
        this.updateDashboard();
    },

    // Delete installment group
    deleteInstallmentGroup(category, parentId) {
        // Find all items in the group
        const groupItems = this.data[category].filter(item => item.parentId === parentId);

        if (groupItems.length === 0) return;

        if (!confirm(`Tem certeza que deseja excluir todas as ${groupItems.length} parcelas deste grupo?`)) return;

        // Remove all items with the same parentId
        this.data[category] = this.data[category].filter(item => item.parentId !== parentId);

        this.saveData();
        this.renderAll();
        this.updateDashboard();
        this.populateAllMonthFilters();
    },

    // Delete all data from a specific month
    deleteMonthData(category) {
        const filterSelectors = {
            loans: 'loans-month-filter',
            fixed: 'fixed-month-filter',
            car: 'car-month-filter',
            general: 'general-month-filter'
        };

        const select = document.getElementById(filterSelectors[category]);
        const selectedMonth = select.value;

        if (!selectedMonth) {
            alert('Por favor, selecione um m√™s para excluir.');
            return;
        }

        // Count items in the selected month
        let itemsToDelete = [];

        this.data[category].forEach(item => {
            let itemMonth = '';

            // Determine the month based on category and item properties
            if (item.installmentDate) {
                itemMonth = item.installmentDate.substring(0, 7);
            } else if (category === 'loans' && item.dueDate) {
                itemMonth = item.dueDate.substring(0, 7);
            } else if (item.date) {
                itemMonth = item.date.substring(0, 7);
            }

            if (itemMonth === selectedMonth) {
                itemsToDelete.push(item);
            }
        });

        if (itemsToDelete.length === 0) {
            alert('Nenhum registro encontrado para este m√™s.');
            return;
        }

        const monthFormatted = this.formatMonthYear(selectedMonth);
        if (!confirm(`Tem certeza que deseja excluir TODOS os ${itemsToDelete.length} registros de ${monthFormatted}?\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) {
            return;
        }

        // Remove items from the selected month
        this.data[category] = this.data[category].filter(item => {
            let itemMonth = '';

            if (item.installmentDate) {
                itemMonth = item.installmentDate.substring(0, 7);
            } else if (category === 'loans' && item.dueDate) {
                itemMonth = item.dueDate.substring(0, 7);
            } else if (item.date) {
                itemMonth = item.date.substring(0, 7);
            }

            return itemMonth !== selectedMonth;
        });

        this.saveData();
        this.renderAll();
        this.updateDashboard();
        this.populateAllMonthFilters();

        alert(`${itemsToDelete.length} registros de ${monthFormatted} foram exclu√≠dos com sucesso!`);
    },

    // Update dashboard
    updateDashboard(selectedMonth = null) {
        // Use selected month from filter, or current month if no filter
        const filterMonth = selectedMonth || new Date().toISOString().substring(0, 7);

        // Car expenses - FILTERED MONTH
        const carTotal = this.data.car
            .filter(item => {
                if (!selectedMonth) return true; // Show all if no filter
                const itemMonth = item.date ? item.date.substring(0, 7) : (item.installmentDate || '').substring(0, 7);
                return itemMonth === filterMonth;
            })
            .reduce((sum, item) => sum + item.amount, 0);

        // General expenses - FILTERED MONTH
        const generalTotal = this.data.general
            .filter(item => {
                if (!selectedMonth) return true; // Show all if no filter
                const itemMonth = item.installmentDate ? item.installmentDate.substring(0, 7) : item.date.substring(0, 7);
                return itemMonth === filterMonth;
            })
            .reduce((sum, item) => sum + item.amount, 0);

        // Fixed monthly expenses
        const fixedMonthly = this.data.fixed.reduce((sum, item) => sum + item.amount, 0);

        // Loans balance (borrowed - lent) - showing MONTHLY value
        // For installments, we group by parent ID and show only one installment value
        // For regular loans, we show the total with interest
        const processedParents = new Set();
        const loansBalance = this.data.loans.reduce((sum, loan) => {
            let amount = 0;

            if (loan.isInstallment) {
                // For installments, count only once per parent (one installment value per month)
                if (!processedParents.has(loan.parentId)) {
                    processedParents.add(loan.parentId);
                    amount = loan.amount; // This is already the monthly installment value
                }
            } else {
                // For regular loans, apply interest and count the full amount
                amount = loan.amount * (1 + loan.interest / 100);
            }

            return sum + (loan.type === 'borrowed' ? -amount : amount);
        }, 0);

        // Total expenses = fixed + car + loans (absolute value) + general
        // Note: We use Math.abs for loans to count debts as expenses
        const totalExpenses = fixedMonthly + carTotal + generalTotal + Math.abs(loansBalance);

        document.getElementById('total-expenses').textContent = `R$ ${totalExpenses.toFixed(2)}`;
        document.getElementById('fixed-monthly').textContent = `R$ ${fixedMonthly.toFixed(2)}`;
        document.getElementById('car-total').textContent = `R$ ${carTotal.toFixed(2)}`;
        document.getElementById('loans-balance').textContent = `R$ ${Math.abs(loansBalance).toFixed(2)}`;
        document.getElementById('loans-balance').style.color = loansBalance >= 0 ? 'var(--success)' : 'var(--danger)';
        document.getElementById('general-total').textContent = `R$ ${generalTotal.toFixed(2)}`;
    },

    // Render all
    renderAll() {
        this.renderLoans();
        this.renderFixed();
        this.renderCar();
        this.renderGeneral();
    },

    // Export data
    exportData() {
        const dataStr = JSON.stringify(this.data, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `controle-gastos-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(url);
    },

    // Import data
    importData() {
        document.getElementById('import-file').click();
    },

    handleImport(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const imported = JSON.parse(e.target.result);
                if (confirm('Isso ir√° substituir todos os dados atuais. Continuar?')) {
                    this.data = imported;
                    this.saveData();
                    this.renderAll();
                    this.updateDashboard();
                    this.populateAllMonthFilters();
                    this.populateDashboardMonthSelector();
                    alert('Dados importados com sucesso!');
                }
            } catch (error) {
                alert('Erro ao importar dados. Verifique o arquivo.');
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    },

    // Helper functions
    formatDate(dateStr) {
        const date = new Date(dateStr + 'T00:00:00');
        return date.toLocaleDateString('pt-BR');
    },

    formatMonthYear(monthStr) {
        const [year, month] = monthStr.split('-');
        const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
        return `${months[parseInt(month) - 1]} ${year}`;
    },

    getStatusLabel(status) {
        const labels = {
            pending: 'Pendente',
            paid: 'Pago',
            overdue: 'Atrasado'
        };
        return labels[status] || status;
    },

    getCategoryLabel(category) {
        const labels = {
            // Fixed
            rent: 'Aluguel',
            internet: 'Internet',
            phone: 'Telefone',
            utilities: 'Contas',
            subscription: 'Assinaturas',
            // Car
            fuel: 'Combust√≠vel',
            maintenance: 'Manuten√ß√£o',
            insurance: 'Seguro',
            taxes: 'Impostos',
            repairs: 'Reparos',
            // General
            food: 'Alimenta√ß√£o',
            transport: 'Transporte',
            health: 'Sa√∫de',
            entertainment: 'Lazer',
            education: 'Educa√ß√£o',
            clothing: 'Vestu√°rio',
            shopping: 'Compras',
            other: 'Outros'
        };
        return labels[category] || category;
    },

    // Populate dashboard month selector with all available months
    populateDashboardMonthSelector() {
        const select = document.getElementById('dashboard-month-selector');
        if (!select) return;

        const months = new Set();

        // Collect months from all categories
        [...this.data.loans, ...this.data.fixed, ...this.data.car, ...this.data.general].forEach(item => {
            let monthKey = '';

            if (item.installmentDate) {
                monthKey = item.installmentDate.substring(0, 7);
            } else if (item.dueDate) {
                monthKey = item.dueDate.substring(0, 7);
            } else if (item.date) {
                monthKey = item.date.substring(0, 7);
            }

            if (monthKey) months.add(monthKey);
        });

        const sortedMonths = Array.from(months).sort().reverse();

        select.innerHTML = '<option value="">Selecione um m√™s</option>' +
            sortedMonths.map(month =>
                `<option value="${month}">${this.formatMonthYear(month)}</option>`
            ).join('');
    },

    // Calculate and display total expenses for selected month
    updateMonthlyTotal() {
        const select = document.getElementById('dashboard-month-selector');
        const display = document.getElementById('monthly-total-display');

        if (!select || !display) return;

        const selectedMonth = select.value;

        if (!selectedMonth) {
            display.textContent = 'R$ 0,00';
            // Reset all filters to show all months
            const loansFilter = document.getElementById('loans-month-filter');
            const fixedFilter = document.getElementById('fixed-month-filter');
            const carFilter = document.getElementById('car-month-filter');
            const generalFilter = document.getElementById('general-month-filter');

            if (loansFilter) loansFilter.value = '';
            if (fixedFilter) fixedFilter.value = '';
            if (carFilter) carFilter.value = '';
            if (generalFilter) generalFilter.value = '';

            // Re-render all tabs
            this.renderLoans('');
            this.renderFixed('');
            this.renderCar('');
            this.renderGeneral('');
            return;
        }

        let total = 0;

        // Calculate loans for the month
        this.data.loans.forEach(loan => {
            const itemMonth = loan.installmentDate
                ? loan.installmentDate.substring(0, 7)
                : (loan.dueDate ? loan.dueDate.substring(0, 7) : '');

            if (itemMonth === selectedMonth) {
                // For borrowed loans, count as expense (negative becomes positive)
                if (loan.type === 'borrowed') {
                    total += loan.amount;
                }
            }
        });

        // Calculate fixed expenses for the month
        // Only count fixed expenses that have a specific month assigned
        this.data.fixed.forEach(item => {
            if (item.installmentDate) {
                const itemMonth = item.installmentDate.substring(0, 7);
                if (itemMonth === selectedMonth) {
                    total += item.amount;
                }
            }
            // Regular fixed expenses without installmentDate are not counted here
            // as they don't have a specific month reference
        });

        // Calculate car expenses for the month
        this.data.car.forEach(item => {
            let itemMonth = '';

            if (item.installmentDate) {
                itemMonth = item.installmentDate.substring(0, 7);
            } else if (item.date) {
                itemMonth = item.date.substring(0, 7);
            }

            if (itemMonth && itemMonth === selectedMonth) {
                total += item.amount;
            }
        });

        // Calculate general expenses for the month
        this.data.general.forEach(item => {
            let itemMonth = '';

            if (item.installmentDate) {
                itemMonth = item.installmentDate.substring(0, 7);
            } else if (item.date) {
                itemMonth = item.date.substring(0, 7);
            }

            if (itemMonth && itemMonth === selectedMonth) {
                total += item.amount;
            }
        });

        display.textContent = `R$ ${total.toFixed(2)}`;

        // Sync all category filters with the selected month
        const loansFilter = document.getElementById('loans-month-filter');
        const fixedFilter = document.getElementById('fixed-month-filter');
        const carFilter = document.getElementById('car-month-filter');
        const generalFilter = document.getElementById('general-month-filter');

        if (loansFilter) loansFilter.value = selectedMonth;
        if (fixedFilter) fixedFilter.value = selectedMonth;
        if (carFilter) carFilter.value = selectedMonth;
        if (generalFilter) generalFilter.value = selectedMonth;

        // Re-render all tabs with the selected month filter
        this.renderLoans(selectedMonth);
        this.renderFixed(selectedMonth);
        this.renderCar(selectedMonth);
        this.renderGeneral(selectedMonth);

        // Update dashboard cards to show filtered month values
        this.updateDashboard(selectedMonth);
    },

    // Open month filter modal
    openMonthFilterModal() {
        const modal = document.getElementById('month-filter-modal');
        if (!modal) return;

        this.populateFilterYears();
        modal.classList.add('active');
    },

    // Close month filter modal
    closeMonthFilterModal() {
        const modal = document.getElementById('month-filter-modal');
        if (!modal) return;

        modal.classList.remove('active');
    },

    // Populate year options in filter
    populateFilterYears() {
        const yearSelect = document.getElementById('filter-year');
        if (!yearSelect) return;

        const years = new Set();

        // Collect years from all categories
        [...this.data.loans, ...this.data.fixed, ...this.data.car, ...this.data.general].forEach(item => {
            let dateStr = '';

            if (item.installmentDate) {
                dateStr = item.installmentDate;
            } else if (item.dueDate) {
                dateStr = item.dueDate;
            } else if (item.date) {
                dateStr = item.date;
            }

            if (dateStr) {
                const year = dateStr.substring(0, 4);
                years.add(year);
            }
        });

        const sortedYears = Array.from(years).sort().reverse();

        yearSelect.innerHTML = '<option value="">Todos os Anos</option>' +
            sortedYears.map(year =>
                `<option value="${year}">${year}</option>`
            ).join('');
    },

    // Apply month and year filter
    applyMonthYearFilter() {
        const monthSelect = document.getElementById('filter-month');
        const yearSelect = document.getElementById('filter-year');

        if (!monthSelect || !yearSelect) return;

        const month = monthSelect.value;
        const year = yearSelect.value;

        let filterValue = '';

        if (year && month) {
            // Both selected: "2027-10"
            filterValue = `${year}-${month}`;
        } else if (year && !month) {
            // Only year selected: show all data for now
            alert(`Selecionando todos os meses de ${year}. Por favor, selecione tamb√©m um m√™s espec√≠fico.`);
            return;
        } else if (!year && month) {
            // Only month selected: show all data for now
            alert(`Selecionando ${this.getMonthName(month)} de todos os anos. Por favor, selecione tamb√©m um ano espec√≠fico.`);
            return;
        } else {
            // Neither selected: clear filter
            filterValue = '';
        }

        // Update all filter dropdowns
        const loansFilter = document.getElementById('loans-month-filter');
        const fixedFilter = document.getElementById('fixed-month-filter');
        const carFilter = document.getElementById('car-month-filter');
        const generalFilter = document.getElementById('general-month-filter');

        if (loansFilter) loansFilter.value = filterValue;
        if (fixedFilter) fixedFilter.value = filterValue;
        if (carFilter) carFilter.value = filterValue;
        if (generalFilter) generalFilter.value = filterValue;

        // Re-render all tabs
        this.renderLoans(filterValue);
        this.renderFixed(filterValue);
        this.renderCar(filterValue);
        this.renderGeneral(filterValue);

        // Update dashboard cards to show filtered month values
        this.updateDashboard(filterValue);

        // Update dashboard month selector if it matches
        const dashboardSelector = document.getElementById('dashboard-month-selector');
        if (dashboardSelector && filterValue) {
            dashboardSelector.value = filterValue;
            this.updateMonthlyTotal();
        }

        this.closeMonthFilterModal();
    },

    // Clear month/year filter
    clearMonthYearFilter() {
        const monthSelect = document.getElementById('filter-month');
        const yearSelect = document.getElementById('filter-year');

        if (monthSelect) monthSelect.value = '';
        if (yearSelect) yearSelect.value = '';

        // Clear all filter dropdowns
        const loansFilter = document.getElementById('loans-month-filter');
        const fixedFilter = document.getElementById('fixed-month-filter');
        const carFilter = document.getElementById('car-month-filter');
        const generalFilter = document.getElementById('general-month-filter');

        if (loansFilter) loansFilter.value = '';
        if (fixedFilter) fixedFilter.value = '';
        if (carFilter) carFilter.value = '';
        if (generalFilter) generalFilter.value = '';

        // Clear dashboard selector
        const dashboardSelector = document.getElementById('dashboard-month-selector');
        if (dashboardSelector) {
            dashboardSelector.value = '';
            this.updateMonthlyTotal();
        }

        // Re-render all tabs without filter
        this.renderLoans('');
        this.renderFixed('');
        this.renderCar('');
        this.renderGeneral('');

        // Update dashboard cards to show all data (no filter)
        this.updateDashboard();

        this.closeMonthFilterModal();
    },

    // Helper: Get month name
    getMonthName(monthNumber) {
        const months = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
        return months[parseInt(monthNumber) - 1] || monthNumber;
    }
};

// Initialize app when DOM is ready
document.addEventListener('DOMContentLoaded', () => app.init());

</script>
</body>

</html>